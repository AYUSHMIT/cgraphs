routine server(channel ch, channel ch2){
    send(ch2, ch)
}

routine foo(channel ch2){
    ch := receive(ch2)
    (req, ch0) := receive(ch);
    result := process(req);
    send(ch0, result)
}

routine client(channel ch){
    ch0 := new_channel();
    send(ch,(request(), ch0));
    receive(ch0)
}

routine main(){
    ch := new_channel();
    ch2 := new_channel();
    fork(server(ch,ch2));
    fork(foo(ch2))
    client(ch)
}